<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firefly Run â€” Singleâ€‘File Test (v4)</title>
  <meta name="theme-color" content="#06240f" />
  <style>
    *{box-sizing:border-box}
    :root{ --bg:#06240f; --ink:#f3ffe9; --acc:#b5ec7f; --edge:#8dcf7a; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);
      font:16px/1.4 ui-rounded,system-ui,Segoe UI,Inter,Arial}
    .nav{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;
      padding:10px 16px;background:linear-gradient(180deg,#081f12,transparent); z-index:3}
    .brand{font-weight:800;letter-spacing:.4px}
    .btn{display:inline-block;padding:10px 14px;border:2px solid var(--edge);border-radius:12px;
      color:var(--ink);text-decoration:none;background:transparent;cursor:pointer}
    .btn:hover{filter:brightness(1.05)} .btn.ghost{border-color:#2f4b35} .btn.xl{font-size:18px;padding:14px 18px}
    #hero{position:relative;overflow:hidden;padding:60px 16px;max-width:1100px;margin:0 auto}
    #hero h1{font-size:46px;margin:0 0 8px} #hero h1 span{color:var(--acc);text-shadow:0 0 18px rgba(181,236,127,.3)}
    #hero .tag{max-width:760px;opacity:.95;margin:0 0 14px} .cta{display:flex;gap:12px;margin:10px 0 6px}
    .quick{display:flex;gap:16px;list-style:none;padding:0;margin:8px 0 0;opacity:.85}
    #bg{position:absolute;inset:auto 0 0 0;width:100%;height:380px;border:0;z-index:0}
    .panel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:linear-gradient(180deg,rgba(12,40,20,.95),rgba(12,40,20,.88));
      border:2px solid var(--edge);border-radius:16px;min-width:320px;max-width:820px;padding:18px;z-index:4}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(84px,1fr));gap:10px}
    .cell{border:2px solid #304a38;background:#b5ec7f;color:#04150a;border-radius:10px;padding:10px 0;
      text-align:center;font-weight:800;cursor:pointer}
    .cell.locked{background:#3a4936;color:#9db29c;border-color:#2a352a;cursor:not-allowed}
    .kv{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center}
    .range{width:220px}
    .canvasWrap{display:flex;justify-content:center;align-items:center;position:relative;z-index:1}
    #game{image-rendering:pixelated;border:3px solid #3e7a46;border-radius:14px;
      box-shadow:0 0 0 4px rgba(24,80,36,.3), 0 30px 120px rgba(0,0,0,.45)}
    .foot{opacity:.7;text-align:center;padding:20px 0}
  </style>
</head>
<body>
  <header class="nav" role="navigation">
    <div class="brand">ðŸª„ Firefly Run</div>
    <nav>
      <button id="btn-play" class="btn" type="button">Play</button>
      <button id="btn-levels" class="btn ghost" type="button">Levels</button>
      <button id="btn-stats" class="btn ghost" type="button">Stats</button>
      <button id="btn-options" class="btn ghost" type="button">Options</button>
    </nav>
  </header>

  <main id="hero">
    <h1>Firefly Run â€” <span>Pro Edition</span></h1>
    <p class="tag">Singleâ€‘file test build to bypass caching. If this works, your full site will too.</p>
    <div class="cta">
      <button id="cta-play" class="btn xl" type="button">â–¶ Play Now</button>
      <button id="cta-how" class="btn ghost" type="button">How to Play</button>
    </div>
    <ul class="quick">
      <li>WASD / Arrows to move</li>
      <li>R to restart â€¢ Esc for menu</li>
      <li>Works offline (PWA disabled in this test file)</li>
    </ul>
    <canvas id="bg" width="1200" height="520" aria-hidden="true"></canvas>
  </main>

  <section id="panel" class="panel hidden" aria-live="polite"></section>

  <div class="canvasWrap"><canvas id="game" width="960" height="520"></canvas></div>

  <footer class="foot">Â© 2025 Firefly Run â€¢ Nature theme</footer>

  <script>
  // Robust wiring: no anchors, click guards, no SW, no external JS.
  (function(){
    const $=s=>document.querySelector(s);
    const on=(el,ev,fn)=>el&&el.addEventListener(ev,(e)=>{e.preventDefault?.(); fn(e)});
    const panel=$("#panel"), bg=$("#bg"), game=$("#game"), c=game.getContext("2d");
    // Background anim
    (function loop(ts){
      const w=bg.width,h=bg.height; const b=bg.getContext('2d');
      b.clearRect(0,0,w,h);
      const g=b.createLinearGradient(0,0,0,h); g.addColorStop(0,'#0b2c1b'); g.addColorStop(1,'#06180d');
      b.fillStyle=g; b.fillRect(0,0,w,h);
      b.globalAlpha=.15; b.fillStyle='#0f3a20';
      for(let i=0;i<8;i++){ const y=40+i*44+Math.sin(ts*0.0005+i)*6; const x=((ts*0.03+i*140)%(w+240))-240;
        b.beginPath(); b.ellipse(x,y,200,36,0,0,Math.PI*2); b.fill(); }
      b.globalAlpha=1; for(let y=0;y<h;y+=24){ for(let x=0;x<w;x+=24){ b.fillStyle=((x/24+y/24)%2==0)?'#135a24':'#0c3b17'; b.fillRect(x,y,24,24);}}
      requestAnimationFrame(loop);
    })(performance.now());
    // Helpers
    const show=(html)=>{ panel.innerHTML=html; panel.classList.remove("hidden"); };
    const hide=()=>panel.classList.add("hidden");
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const rectI=(a,b)=>!(a.x+a.w<b.x||b.x+b.w<a.x||a.y+a.h<b.y||b.y+b.h<a.y);
    const R=(x,y,w,h)=>({x,y,w,h});
    function cRect(px,py,pr,r){const cx=clamp(px,r.x,r.x+r.w),cy=clamp(py,r.y,r.y+r.h); const dx=px-cx,dy=py-cy; return dx*dx+dy*dy<=pr*pr;}
    function hedge(r){ c.fillStyle='#2a8d4e'; c.fillRect(r.x,r.y,r.w,r.h); c.strokeStyle='#0d411e'; c.lineWidth=2; c.strokeRect(r.x,r.y,r.w,r.h); }
    function glade(g){ c.fillStyle='#b5ec7f'; c.fillRect(g.x,g.y,g.w,g.h); c.strokeStyle='#2b5a2a'; c.lineWidth=2; c.strokeRect(g.x,g.y,g.w,g.h); }
    function firefly(t,ts){ const cx=t.x+t.w/2,cy=t.y+t.h/2,r=6+2*(.5+.5*Math.sin(ts*0.01+(cx+cy)*.02)); const grd=c.createRadialGradient(cx,cy,0,cx,cy,r*3); grd.addColorStop(0,'rgba(255,220,0,.9)'); grd.addColorStop(1,'rgba(255,220,0,0)'); c.fillStyle=grd; c.beginPath(); c.arc(cx,cy,r*3,0,Math.PI*2); c.fill(); c.fillStyle='#ffdc00'; c.beginPath(); c.arc(cx,cy,r,0,Math.PI*2); c.fill(); }
    function tx(s,x,y,sz=18,col='#f3ffe9'){ c.font='bold '+sz+'px ui-rounded, ui-sans-serif'; c.lineWidth=4; c.strokeStyle='rgba(0,0,0,.6)'; c.strokeText(s,x,y); c.fillStyle=col; c.fillText(s,x,y); }

    // Simple generated level set (20)
    const W=960,H=520, LV=[];
    function addL(start,goal,walls,tok,enm){ LV.push({start,goal,walls,tok,enm}); }
    function line(y,n,s){ const a=[]; const step=(W-160)/(Math.max(1,n)-1||1); for(let i=0;i<n;i++) a.push({r:R(120+i*step-8,y-8,16,16), path:[[120+i*step,y],[W-120-i*step,y]], speed:s, bounce:true}); return a; }
    addL([80,260],R(W-120,240,40,60),[R(0,0,W,20),R(0,H-20,W,20),R(0,0,20,H),R(W-20,0,20,H),R(220,120,20,280),R(420,120,20,280),R(620,120,20,280)],[R(300,90,20,20),R(520,430,20,20),R(740,90,20,20)],
     [{r:R(140,260,16,16),path:[[140,100],[140,420]],speed:3,bounce:true},{r:R(340,260,16,16),path:[[340,100],[340,420]],speed:3,bounce:true},{r:R(540,260,16,16),path:[[540,100],[540,420]],speed:3,bounce:true},{r:R(740,260,16,16),path:[[740,100],[740,420]],speed:3,bounce:true}]);
    for(let i=2;i<=20;i++){ const y1=100+((i*37)%280), y2=H-100-((i*53)%280);
      const walls=[R(0,0,W,20),R(0,H-20,W,20),R(0,0,20,H),R(W-20,0,20,H), R(160,y1,W-320,20), R(160,y2,W-320,20)];
      const tok=[R(240,60,20,20),R(W-260,H-80,20,20),R(W/2-10,H/2-10,20,20)];
      const enm=line(y1-40,3+((i%3)),4+(i%4)).concat(line(y2+40,3+((i+1)%3),4+((i+2)%4)));
      addL([80,(i%2)?80:H-80], R(W-120,(i%2)?H-120:80,40,60), walls, tok, enm);
    }

    const save={best: JSON.parse(localStorage.getItem('ffp_best')||'{}'), unlocked: parseInt(localStorage.getItem('ffp_unlocked')||'1',10)};
    const DIFF={NORMAL:{pR:10,pS:3.6,eM:1.0},HARD:{pR:11,pS:3.2,eM:1.25},INSANE:{pR:12,pS:3.0,eM:1.55}};
    let diff=localStorage.getItem('ffp_diff')||'HARD';

    let keys={};
    function boot(i){ runLevel(Math.max(0, Math.min(i, LV.length-1))); hide(); }

    function runLevel(i){
      const L=LV[i], tset=DIFF[diff]; let t=0, tokens=L.tok.map(o=>({ ...o }));
      const walls=L.walls.map(o=>({...o})), goal={...L.goal};
      const enemies=L.enm.map(e=>({r:{...e.r}, path=e.path.map(p=>({x:p[0],y:p[1]})), speed:e.speed, bounce:!!e.bounce, idx:0, dir:1}));
      const p={x:L.start[0], y:L.start[1], r:tset.pR, s:tset.pS};
      let run=true, lf=performance.now();
      function step(dt){
        t+=dt; let vx=(keys['ArrowRight']||keys['d']||keys['D']?1:0)-(keys['ArrowLeft']||keys['a']||keys['A']?1:0);
        let vy=(keys['ArrowDown']||keys['s']||keys['S']?1:0)-(keys['ArrowUp']||keys['w']||keys['W']?1:0);
        const sp=p.s*((vx&&vy)?1.414:1); p.x=clamp(p.x+(vx? (vx>0?1:-1):0)*sp, p.r, 960-p.r); p.y=clamp(p.y+(vy? (vy>0?1:-1):0)*sp, p.r, 520-p.r);
        const pr={x:p.x-p.r,y:p.y-p.r,w:p.r*2,h:p.r*2}; for(const w of walls){ if(rectI(pr,w)){ die(); return; } }
        const mul=DIFF[diff].eM; for(const e of enemies){ const tgt=e.path[e.idx+e.dir]||e.path[e.idx]; let dx=tgt.x-(e.r.x+e.r.w/2), dy=tgt.y-(e.r.y+e.r.h/2); const dist=Math.hypot(dx,dy)||1; const s=e.speed*mul; if(dist<=s){ e.r.x=tgt.x-e.r.w/2; e.r.y=tgt.y-e.r.h/2; if(e.bounce){ if(e.idx+e.dir>=e.path.length-1 || e.idx+e.dir<0) e.dir*=-1; else e.idx+=e.dir; } else { e.idx=(e.idx+1)%e.path.length; } } else { e.r.x+=Math.round(s*dx/dist); e.r.y+=Math.round(s*dy/dist); } if(cRect(p.x,p.y,p.r,e.r)){ die(); return; } }
        const before=tokens.length; tokens=tokens.filter(o=>!cRect(p.x,p.y,p.r,o));
        if(tokens.length===0 && cRect(p.x,p.y,p.r,goal)){ win(t); return; }
      }
      function draw(ts){
        c.clearRect(0,0,960,520); for(const w of walls) hedge(w); glade(goal); for(const to of tokens) firefly(to,ts);
        for(const e of enemies){ c.fillStyle='#e14d4d'; c.fillRect(e.r.x,e.r.y,e.r.w,e.r.h); c.strokeStyle='#5a1010'; c.lineWidth=2; c.strokeRect(e.r.x,e.r.y,e.r.w,e.r.h); }
        c.fillStyle='#fff'; c.beginPath(); c.arc(p.x,p.y,p.r,0,Math.PI*2); c.fill(); c.lineWidth=2; c.strokeStyle='#8dcf7a'; c.beginPath(); c.arc(p.x,p.y,p.r,0,Math.PI*2); c.stroke();
        tx(`Level ${i+1}/${LV.length}`,12,24); tx(`Fireflies ${tokens.length}`,12,48); tx(`Time ${t.toFixed(2)}s`,12,72);
      }
      function frame(ts){ const dt=Math.min(.05,(ts-lf)/1000); lf=ts; if(run){ step(dt); draw(ts); requestAnimationFrame(frame); } }
      function die(){ run=false; setTimeout(()=>runLevel(i),120); }
      function win(time){ show(`<h2>Glade Reached!</h2><div>Time: ${time.toFixed(2)}s</div><div style="text-align:right;margin-top:8px"><a class="btn" id="n" href="#">Next</a></div>`);
        const n=document.getElementById('n'); n&&n.addEventListener('click',(e)=>{e.preventDefault(); hide(); if(i+1<LV.length) runLevel(i+1); });
      }
      window.onkeydown=(e)=>{ keys[e.key]=true; if(e.key && e.key.toLowerCase()==='r'){ die(); } if(e.key==='Escape'){ show('<h2>Paused</h2><div style="text-align:right"><a class="btn" id="r" href="#">Resume</a></div>'); const r=document.getElementById('r'); r&&r.addEventListener('click',(ev)=>{ev.preventDefault(); hide();}); } };
      window.onkeyup=(e)=>{ keys[e.key]=false; };
      requestAnimationFrame(frame);
    }

    // Buttons â€” absolutely minimal wiring
    on($("#btn-play"),'click',()=>boot(0));
    on($("#cta-play"),'click',()=>boot(0));
    on($("#btn-levels"),'click',()=>{
      const cells=Array.from({length:20},(_,i)=>`<div class='cell' data-i='${i}'>${i+1}</div>`).join('');
      show(`<h2>Select Level</h2><div class='grid'>${cells}</div><div style='text-align:right'><a class='btn ghost' id='back' href='#'>Back</a></div>`);
      panel.querySelectorAll('.cell').forEach(el=>el.addEventListener('click',()=>{ hide(); boot(parseInt(el.dataset.i)); }));
      panel.querySelector('#back').addEventListener('click',(e)=>{e.preventDefault(); hide();});
    });
    on($("#btn-stats"),'click',()=>{ show("<h2>Stats</h2><p>Best times saved locally.</p><div style='text-align:right'><a id='x' class='btn ghost' href='#'>Close</a></div>"); panel.querySelector('#x').addEventListener('click',(e)=>{e.preventDefault(); hide();}); });
    on($("#btn-options"),'click',()=>{ show("<h2>Options</h2><p>More coming soon.</p><div style='text-align:right'><a id='x' class='btn ghost' href='#'>Close</a></div>"); panel.querySelector('#x').addEventListener('click',(e)=>{e.preventDefault(); hide();}); });
    on($("#cta-how"),'click',()=>alert('Collect the glowing fireflies, reach the glade, avoid reds. WASD/Arrows move, R restarts, Esc menu.'));
  })();
  </script>
</body>
</html>
